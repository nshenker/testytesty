<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antique Arena - Inventory Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #fdfaf6;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Merriweather', serif;
        }
        .modal {
            display: none;
            transition: opacity 0.3s ease;
            z-index: 50; /* Base z-index for modals */
        }
        /* Higher z-index for modals that can open on top of other modals */
        .modal-top {
            z-index: 60;
        }
        .modal.active {
            display: flex;
        }
        #video-container.hidden {
            display: none;
        }
        .modal-content {
            max-height: 90vh;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 160px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -80px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        /* Toast Notifications */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.5s forwards, fadeOut 0.5s 2.5s forwards;
        }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }
        @keyframes slideIn {
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        /* Tag styles */
        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #e2e8f0;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4a5568;
        }
        .tag-remove {
            margin-left: 0.5rem;
            cursor: pointer;
            color: #718096;
        }
        .tag-remove:hover {
            color: #2d3748;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-800">Antique Arena</h1>
            <p class="text-lg text-gray-600">Inventory Management System</p>
        </header>

        <main>
            <!-- Dashboard -->
            <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-2xl font-bold text-amber-800" id="totalShelvesStat">0</h3>
                    <p class="text-gray-600">Total Shelves</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-2xl font-bold text-amber-800" id="totalItemsStat">0</h3>
                    <p class="text-gray-600">Total Items</p>
                </div>
            </div>

            <!-- Global Controls -->
            <div class="bg-white/80 backdrop-blur-sm sticky top-0 z-20 p-4 rounded-xl shadow-md mb-8">
                <div class="flex flex-wrap justify-center md:justify-end gap-2">
                    <button id="importBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-transform transform hover:scale-105 tooltip">Import<span class="tooltiptext">Import items from .csv</span></button>
                    <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg shadow-md transition-transform transform hover:scale-105 tooltip">Export<span class="tooltiptext">Export all items to .csv</span></button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap justify-center gap-4 mb-8">
                <button id="manageShelvesBtn" class="bg-amber-700 hover:bg-amber-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Manage Shelves</button>
                <button id="addItemBtn" class="bg-stone-700 hover:bg-stone-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Add New Item</button>
                <button id="scanModeBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Enter Scanning Mode</button>
            </div>

            <!-- Main Display Area for Unassigned Items -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-stone-800 mb-4 border-b pb-2">Unassigned Items</h2>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <button class="view-unassigned-btn w-full bg-stone-600 hover:bg-stone-700 text-white font-bold py-3 px-4 rounded-lg text-lg">
                        View Unassigned Items (<span id="unassigned-count">0</span>)
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Manage Shelves Modal -->
    <div id="shelvesListModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-6xl modal-content flex flex-col">
            <h2 class="text-3xl font-bold text-amber-800 mb-4">Manage Shelves</h2>
             <!-- Controls: Search, Sort, Actions -->
            <div class="bg-gray-100 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                    <div class="md:col-span-1">
                        <input type="search" id="shelfSearchInput" placeholder="Search shelves..." class="w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-amber-500 transition">
                    </div>
                    <div class="md:col-span-1">
                         <select id="shelfSortSelect" class="w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-amber-500 transition">
                             <option value="name-asc">Sort by Name (A-Z)</option>
                             <option value="name-desc">Sort by Name (Z-A)</option>
                             <option value="items-desc">Sort by Items (Most First)</option>
                             <option value="items-asc">Sort by Items (Fewest First)</option>
                         </select>
                    </div>
                    <div class="md:col-span-1 flex flex-wrap justify-center md:justify-end gap-2">
                         <button id="addShelfBtn" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-3 rounded-lg">Add Shelf</button>
                         <button id="printSelectedShelvesBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-3 rounded-lg disabled:opacity-50" disabled>Print Selected QR</button>
                    </div>
                </div>
            </div>

            <div id="shelvesListContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 overflow-y-auto flex-grow p-2">
                <!-- Shelf cards will be dynamically added here -->
            </div>
             <div class="flex justify-end mt-6">
                <button class="modal-cancel bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Shelf Modal -->
    <div id="shelfModal" class="modal modal-top fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <h2 id="shelfModalTitle" class="text-2xl font-bold mb-4">Add a New Shelf</h2>
            <input type="text" id="shelfNameInput" placeholder="Shelf Name or Location" class="w-full p-2 border rounded-md mb-4">
            <input type="hidden" id="shelfIdInput">
            <div class="flex justify-end gap-4">
                <button class="modal-cancel bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="saveShelf" class="bg-amber-700 hover:bg-amber-800 text-white font-bold py-2 px-4 rounded-lg">Save Shelf</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal modal-top fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md modal-content overflow-y-auto">
            <h2 id="itemModalTitle" class="text-2xl font-bold mb-4">Add a New Item</h2>
            <input type="hidden" id="originalItemNameInput">
            <div class="space-y-4">
                <div>
                    <label for="itemNameInput" class="block text-sm font-medium text-gray-700">Item Name (Unique ID)</label>
                    <input type="text" id="itemNameInput" placeholder="e.g., 'Victorian Armchair'" class="mt-1 w-full p-2 border rounded-md">
                </div>
                <div>
                    <label for="itemDescriptionInput" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="itemDescriptionInput" placeholder="e.g., 'Hand-carved mahogany, circa 1880'" class="mt-1 w-full p-2 border rounded-md" rows="3"></textarea>
                </div>
                 <div>
                    <label for="itemValueInput" class="block text-sm font-medium text-gray-700">Estimated Value ($)</label>
                    <input type="number" id="itemValueInput" placeholder="e.g., 2500" class="mt-1 w-full p-2 border rounded-md">
                </div>
                <div>
                    <label for="itemAcquiredInput" class="block text-sm font-medium text-gray-700">Acquisition Date</label>
                    <input type="date" id="itemAcquiredInput" class="mt-1 w-full p-2 border rounded-md">
                </div>
                 <div>
                    <label for="itemConditionInput" class="block text-sm font-medium text-gray-700">Condition</label>
                    <select id="itemConditionInput" class="mt-1 w-full p-2 border rounded-md bg-white">
                        <option value="Unknown">Unknown</option>
                        <option value="Mint">Mint</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Damaged">Damaged</option>
                    </select>
                </div>
                <div>
                    <label for="itemTagsInput" class="block text-sm font-medium text-gray-700">Tags</label>
                    <input type="text" id="itemTagsInput" list="tagsDatalist" placeholder="Type a tag and press Enter" class="mt-1 w-full p-2 border rounded-md">
                    <datalist id="tagsDatalist"></datalist>
                    <div id="itemTagsContainer" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button class="modal-cancel bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="saveItem" class="bg-stone-700 hover:bg-stone-800 text-white font-bold py-2 px-4 rounded-lg">Save Item</button>
            </div>
        </div>
    </div>

    <!-- View Items Modal -->
    <div id="viewItemsModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-3xl modal-content flex flex-col">
            <div class="flex justify-between items-center border-b pb-2 mb-4">
                <h2 id="viewItemsTitle" class="text-2xl font-bold text-amber-800">Items</h2>
                <button id="saveLotSheetBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Save Lot Sheet</button>
            </div>
            <div id="viewItemsContent" class="space-y-3 overflow-y-auto flex-grow pr-2">
                <!-- Items list will be dynamically populated here -->
            </div>
            <div id="bulkActionsBar" class="hidden mt-4 pt-4 border-t flex flex-wrap justify-between items-center gap-4">
                <div>
                    <span id="selectedItemCount" class="font-bold">0</span> items selected
                </div>
                <div class="flex flex-wrap gap-2">
                    <button id="generateQrSheetBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Print Selected QR</button>
                    <button id="moveSelectedBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Move</button>
                    <button id="deleteSelectedBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Delete</button>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button class="modal-cancel bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Move Items Modal -->
    <div id="moveItemsModal" class="modal modal-top fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Move Items To...</h2>
            <input type="search" id="moveShelfSearchInput" placeholder="Search for a destination shelf..." class="w-full p-2 border rounded-md mb-2">
            <select id="moveShelfSelect" class="w-full p-2 border rounded-md mb-4 bg-white" size="8"></select>
            <div class="flex justify-end gap-4">
                <button class="modal-cancel bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="confirmMoveBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Confirm Move</button>
            </div>
        </div>
    </div>

    <!-- Audit Modal -->
    <div id="auditModal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-xl modal-content flex flex-col">
            <h2 id="auditModalTitle" class="text-2xl font-bold text-purple-800 border-b pb-2 mb-4">Auditing Shelf</h2>
            <div class="flex-grow flex flex-col gap-6 overflow-y-auto">
                <!-- Scanner -->
                <div class="flex flex-col items-center">
                    <div id="audit-video-container" class="relative w-full max-w-sm aspect-square bg-gray-900 rounded-lg mb-2">
                        <video id="audit-qr-video" class="w-full h-full rounded-lg object-cover"></video>
                        <div class="absolute inset-0 border-4 border-purple-500 rounded-lg" style="box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);"></div>
                    </div>
                    <p id="audit-scan-status" class="text-lg font-medium text-center">Scan items to verify...</p>
                </div>
                <!-- Lists -->
                <div class="flex flex-col gap-4 overflow-y-auto pr-2">
                    <div>
                        <h3 class="font-bold text-lg text-green-700 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Found Items (<span id="audit-found-count">0</span>)
                        </h3>
                        <div id="audit-found-list" class="space-y-2 mt-2 pl-8"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-red-700 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Missing Items (<span id="audit-missing-count">0</span>)
                        </h3>
                        <div id="audit-missing-list" class="space-y-2 mt-2 pl-8"></div>
                    </div>
                     <div>
                        <h3 class="font-bold text-lg text-yellow-700 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                            Unexpected Items (<span id="audit-unexpected-count">0</span>)
                        </h3>
                        <div id="audit-unexpected-list" class="space-y-2 mt-2 pl-8"></div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="finishAuditBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Finish Audit</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="modal modal-top fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md text-center">
            <h2 id="confirmTitle" class="text-xl font-bold mb-2">Are you sure?</h2>
            <p id="confirmMessage" class="text-gray-600 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancel</button>
                <button id="confirmOkBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Scanning Mode Modal -->
    <div id="scanModeModal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl text-center">
            <h2 class="text-2xl font-bold mb-4">Scanning Mode</h2>
            <div id="video-container" class="relative w-full aspect-video bg-gray-900 rounded-lg mb-4 hidden">
                <video id="qr-video" class="w-full h-full rounded-lg"></video>
                <div class="absolute inset-0 border-4 border-red-500 rounded-lg" style="box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);"></div>
            </div>
            <p id="scan-status" class="text-lg font-medium mb-2">Please scan a shelf QR code.</p>
            <p id="current-shelf-info" class="text-md text-gray-600 mb-4">No shelf selected.</p>
            <div class="flex justify-center gap-4">
                 <button id="scan-add-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50" disabled>Scan to ADD</button>
                 <button id="scan-remove-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50" disabled>Scan to REMOVE</button>
                 <button id="exitScanMode" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Exit Scanning</button>
            </div>
        </div>
    </div>
    
    <!-- QR Code Display Modal -->
    <div id="qrCodeModal" class="modal modal-top fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 text-center">
            <h3 id="qrCodeTitle" class="text-2xl font-bold mb-4">QR Code</h3>
            <canvas id="qrCodeCanvas" class="mx-auto"></canvas>
            <div class="mt-4">
                <button id="printQrCode" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Print</button>
                <button class="modal-cancel bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="importFile" class="hidden" accept=".csv">
    <div id="toast-container"></div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // State Management
            let inventoryData = JSON.parse(localStorage.getItem('antiqueArenaInventory')) || { shelves: [], unassignedItems: [], allTags: [] };
            let videoStream;
            let currentScanMode = null; // 'add', 'remove', or 'audit'
            let currentShelfId = null;
            let currentAuditShelf = null;
            let selectedItems = new Set();
            let selectedShelves = new Set();
            let currentItemTags = new Set();

            // UI Elements
            const manageShelvesBtn = document.getElementById('manageShelvesBtn');
            const addShelfBtn = document.getElementById('addShelfBtn');
            const addItemBtn = document.getElementById('addItemBtn');
            const scanModeBtn = document.getElementById('scanModeBtn');
            const modals = document.querySelectorAll('.modal');
            const exitScanModeBtn = document.getElementById('exitScanMode');
            const importBtn = document.getElementById('importBtn');
            const exportBtn = document.getElementById('exportBtn');
            const importFile = document.getElementById('importFile');
            const saveLotSheetBtn = document.getElementById('saveLotSheetBtn');
            const finishAuditBtn = document.getElementById('finishAuditBtn');
            const generateQrSheetBtn = document.getElementById('generateQrSheetBtn');
            const viewUnassignedBtn = document.querySelector('.view-unassigned-btn');

            // --- UX Functions ---
            const showToast = (message, type = 'success') => {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            };

            const customConfirm = (message, title = 'Are you sure?') => {
                return new Promise((resolve) => {
                    const modal = document.getElementById('confirmModal');
                    document.getElementById('confirmTitle').textContent = title;
                    document.getElementById('confirmMessage').textContent = message;
                    
                    const confirmBtn = document.getElementById('confirmOkBtn');
                    const cancelBtn = document.getElementById('confirmCancelBtn');

                    const close = (result) => {
                        closeModal(modal);
                        // By cloning and replacing, we remove the old event listeners
                        confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                        cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                        resolve(result);
                    };
                    
                    document.getElementById('confirmOkBtn').addEventListener('click', () => close(true), { once: true });
                    document.getElementById('confirmCancelBtn').addEventListener('click', () => close(false), { once: true });

                    openModal(modal);
                });
            };

            // --- Data Functions ---
            const saveData = () => {
                // Ensure allTags is up-to-date
                const allItems = [...inventoryData.unassignedItems, ...inventoryData.shelves.flatMap(s => s.items)];
                const tags = new Set(allItems.flatMap(item => item.tags || []));
                inventoryData.allTags = Array.from(tags).sort();

                localStorage.setItem('antiqueArenaInventory', JSON.stringify(inventoryData));
                updateDashboard();
                updateTagsDatalist();
            };
            
            const updateDashboard = () => {
                const totalShelves = inventoryData.shelves.length;
                const totalItems = inventoryData.unassignedItems.length + inventoryData.shelves.reduce((sum, shelf) => sum + shelf.items.length, 0);
                document.getElementById('totalShelvesStat').textContent = totalShelves;
                document.getElementById('totalItemsStat').textContent = totalItems;
                document.getElementById('unassigned-count').textContent = inventoryData.unassignedItems.length;
            };

            // --- Rendering Functions ---
            const renderShelvesListModal = () => {
                const container = document.getElementById('shelvesListContainer');
                const searchInput = document.getElementById('shelfSearchInput');
                const sortSelect = document.getElementById('shelfSortSelect');
                
                const searchTerm = searchInput.value.toLowerCase();
                const sortValue = sortSelect.value;
                container.innerHTML = '';

                let filteredShelves = inventoryData.shelves.filter(shelf => {
                    const shelfMatch = shelf.name.toLowerCase().includes(searchTerm);
                    const itemMatch = shelf.items.some(item => 
                        item.name.toLowerCase().includes(searchTerm) || 
                        (item.description && item.description.toLowerCase().includes(searchTerm))
                    );
                    return shelfMatch || itemMatch;
                });

                // Sorting logic
                switch (sortValue) {
                    case 'name-asc':
                        filteredShelves.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'name-desc':
                        filteredShelves.sort((a, b) => b.name.localeCompare(a.name));
                        break;
                    case 'items-desc':
                        filteredShelves.sort((a, b) => b.items.length - a.items.length);
                        break;
                    case 'items-asc':
                        filteredShelves.sort((a, b) => a.items.length - b.items.length);
                        break;
                }
                
                // Render Shelves
                if (filteredShelves.length > 0) {
                    filteredShelves.forEach(shelf => {
                        const shelfElement = createShelfCardElement(shelf);
                        container.appendChild(shelfElement);
                    });
                } else {
                    container.innerHTML = `<div class="text-center py-16 px-6 bg-gray-50 rounded-lg col-span-full">
                        <h3 class="text-2xl font-bold text-amber-800 mb-2">No Shelves Found</h3>
                        <p class="text-gray-600">Try a different search or add a new shelf.</p>
                    </div>`;
                }
                updateShelfBulkActionsBar();
            };
            
            const createShelfCardElement = (shelf) => {
                const element = document.createElement('div');
                element.className = 'bg-amber-50 p-4 rounded-lg shadow-md flex flex-col justify-between transition-transform transform hover:-translate-y-1';
                element.setAttribute('data-id', shelf.id);
                const isSelected = selectedShelves.has(shelf.id);

                element.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-2">
                             <h3 class="text-xl font-bold text-amber-800 truncate pr-2">${shelf.name}</h3>
                             <input type="checkbox" class="shelf-checkbox h-5 w-5 rounded border-gray-400 text-amber-600 focus:ring-amber-500" data-shelf-id="${shelf.id}" ${isSelected ? 'checked' : ''}>
                        </div>
                        <p class="text-gray-600 mb-4">${shelf.items.length} item(s)</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="view-items-btn flex-grow bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-3 rounded-lg text-sm">View Items</button>
                        <button class="audit-shelf-btn flex-grow bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Audit</button>
                    </div>
                    <div class="flex justify-end gap-2 mt-2">
                        <button class="edit-shelf-btn p-2 bg-gray-200 hover:bg-gray-300 rounded-full" title="Edit Shelf">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button class="show-shelf-qr-btn p-2 bg-gray-200 hover:bg-gray-300 rounded-full" title="Show Shelf QR Code">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h4v4H4zM4 16h4v4H4zM16 4h4v4h-4zM16 16h4v4h-4zM10 4h4v4h-4zM10 16h4v4h-4zM4 10h4v4H4zM16 10h4v4h-4zM10 10h4v4h-4z"/></svg>
                        </button>
                        <button class="delete-shelf-btn p-2 bg-red-100 hover:bg-red-200 rounded-full" title="Delete Shelf">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
                return element;
            };

            const createItemElementForModal = (item) => {
                const element = document.createElement('div');
                element.className = 'bg-white p-4 rounded-lg shadow-sm flex items-start gap-4';
                element.setAttribute('data-name', item.name);

                const value = item.value ? `$${parseFloat(item.value).toLocaleString()}` : 'N/A';
                const acquired = item.acquired || 'N/A';
                const condition = item.condition || 'Unknown';
                const tagsHTML = (item.tags && item.tags.length > 0) 
                    ? `<div class="flex flex-wrap gap-2 mt-3">${item.tags.map(tag => `<span class="bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">${tag}</span>`).join('')}</div>`
                    : '';

                element.innerHTML = `
                    <div>
                        <input type="checkbox" class="item-checkbox h-5 w-5 rounded border-gray-300 text-amber-600 focus:ring-amber-500" data-item-name="${item.name}">
                    </div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-lg text-gray-800">${item.name}</p>
                                <p class="text-sm text-gray-600 mt-1">${item.description || 'No description.'}</p>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0 ml-4">
                                <button class="edit-item-btn text-gray-400 hover:text-blue-600" title="Edit Item">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                </button>
                                <button class="show-item-qr-btn text-gray-400 hover:text-stone-700" title="Show Item QR Code">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h4v4H4zM4 16h4v4H4zM16 4h4v4h-4zM16 16h4v4h-4zM10 4h4v4h-4zM10 16h4v4h-4zM4 10h4v4H4zM16 10h4v4h-4zM10 10h4v4h-4z"/></svg>
                                </button>
                                <button class="delete-item-btn text-red-400 hover:text-red-600" title="Delete Item">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                            <div><strong class="block text-gray-500">Value</strong> ${value}</div>
                            <div><strong class="block text-gray-500">Acquired</strong> ${acquired}</div>
                            <div><strong class="block text-gray-500">Condition</strong> <span class="inline-block bg-gray-200 rounded-full px-2 py-0.5 text-xs font-semibold text-gray-700">${condition}</span></div>
                        </div>
                        ${tagsHTML}
                    </div>
                `;
                return element;
            };

            const findItem = (itemName) => {
                for (const shelf of inventoryData.shelves) {
                    const item = shelf.items.find(i => i.name === itemName);
                    if (item) return item;
                }
                return inventoryData.unassignedItems.find(i => i.name === itemName);
            };
            
            const findItemLocation = (itemName) => {
                for (const shelf of inventoryData.shelves) {
                    if (shelf.items.some(i => i.name === itemName)) {
                        return { list: shelf.items, index: shelf.items.findIndex(i => i.name === itemName), shelf: shelf };
                    }
                }
                const unassignedIndex = inventoryData.unassignedItems.findIndex(i => i.name === itemName);
                if (unassignedIndex > -1) {
                    return { list: inventoryData.unassignedItems, index: unassignedIndex, shelf: null };
                }
                return null;
            };

            // --- Modal Handling ---
            const openModal = (modal) => modal.classList.add('active');
            const closeModal = (modal) => modal.classList.remove('active');

            manageShelvesBtn.addEventListener('click', () => {
                const modal = document.getElementById('shelvesListModal');
                selectedShelves.clear();
                renderShelvesListModal();
                openModal(modal);
            });

            addShelfBtn.addEventListener('click', () => {
                const modal = document.getElementById('shelfModal');
                document.getElementById('shelfModalTitle').textContent = 'Add a New Shelf';
                document.getElementById('shelfNameInput').value = '';
                document.getElementById('shelfIdInput').value = '';
                openModal(modal);
            });

            addItemBtn.addEventListener('click', () => {
                const modal = document.getElementById('itemModal');
                document.getElementById('itemModalTitle').textContent = 'Add a New Item';
                document.getElementById('originalItemNameInput').value = '';
                document.getElementById('itemNameInput').value = '';
                document.getElementById('itemDescriptionInput').value = '';
                document.getElementById('itemValueInput').value = '';
                document.getElementById('itemAcquiredInput').value = '';
                document.getElementById('itemConditionInput').value = 'Unknown';
                currentItemTags.clear();
                renderCurrentItemTags();
                openModal(modal);
            });
            
            scanModeBtn.addEventListener('click', () => {
                currentScanMode = 'add/remove';
                openModal(document.getElementById('scanModeModal'));
                startScanner(document.getElementById('qr-video'));
            });
            
            exitScanModeBtn.addEventListener('click', () => {
                stopScanner();
                closeModal(document.getElementById('scanModeModal'));
            });

            modals.forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal-cancel')) {
                        closeModal(modal);
                    }
                });
            });
            
            // --- Event Handlers ---
            document.getElementById('saveShelf').addEventListener('click', () => {
                const shelfName = document.getElementById('shelfNameInput').value.trim();
                const shelfId = document.getElementById('shelfIdInput').value;
                if (shelfName) {
                    if (shelfId) { // Editing existing shelf
                        const shelf = inventoryData.shelves.find(s => s.id === shelfId);
                        if (shelf) shelf.name = shelfName;
                    } else { // Adding new shelf
                        inventoryData.shelves.push({ id: `shelf_${Date.now()}`, name: shelfName, items: [] });
                    }
                    saveData();
                    closeModal(document.getElementById('shelfModal'));
                    renderShelvesListModal(); // Re-render the shelves list
                    showToast('Shelf saved successfully.');
                }
            });

            document.getElementById('saveItem').addEventListener('click', () => {
                const newItemName = document.getElementById('itemNameInput').value.trim();
                const originalName = document.getElementById('originalItemNameInput').value;

                if (!newItemName) {
                    showToast('Item Name is required.', 'error');
                    return;
                }

                if (newItemName !== originalName && findItem(newItemName)) {
                    showToast(`An item with the name "${newItemName}" already exists.`, 'error');
                    return;
                }

                const newItemData = {
                    name: newItemName,
                    description: document.getElementById('itemDescriptionInput').value.trim(),
                    value: document.getElementById('itemValueInput').value,
                    acquired: document.getElementById('itemAcquiredInput').value,
                    condition: document.getElementById('itemConditionInput').value,
                    tags: Array.from(currentItemTags)
                };

                if (originalName) { // Editing existing item
                    const location = findItemLocation(originalName);
                    if (location) {
                        location.list[location.index] = { ...location.list[location.index], ...newItemData };
                    }
                } else { // Adding new item
                    inventoryData.unassignedItems.push(newItemData);
                }
                saveData();
                closeModal(document.getElementById('itemModal'));
                showToast('Item saved successfully.');
            });

            document.getElementById('shelvesListContainer').addEventListener('click', async (e) => {
                const card = e.target.closest('[data-id]');
                if (!card) return;

                const shelfId = card.dataset.id;
                const viewItemsBtn = e.target.closest('.view-items-btn');
                const shelfQrBtn = e.target.closest('.show-shelf-qr-btn');
                const deleteShelfBtn = e.target.closest('.delete-shelf-btn');
                const editShelfBtn = e.target.closest('.edit-shelf-btn');
                const auditShelfBtn = e.target.closest('.audit-shelf-btn');
                const checkbox = e.target.closest('.shelf-checkbox');

                if (checkbox) {
                    if (checkbox.checked) {
                        selectedShelves.add(shelfId);
                    } else {
                        selectedShelves.delete(shelfId);
                    }
                    updateShelfBulkActionsBar();
                }
                if (viewItemsBtn) {
                    const shelf = inventoryData.shelves.find(s => s.id === shelfId);
                    showItemsModal(`Items on: ${shelf.name}`, shelf.items, shelfId);
                }
                if (shelfQrBtn) {
                    const shelf = inventoryData.shelves.find(s => s.id === shelfId);
                    showQrCode(shelf.id, `Shelf: ${shelf.name}`);
                }
                if (deleteShelfBtn) {
                    const confirmed = await customConfirm('This will move all items on the shelf to "Unassigned". Continue?');
                    if(confirmed) {
                        deleteShelf(shelfId);
                        showToast('Shelf deleted.', 'info');
                    }
                }
                if (editShelfBtn) {
                    const shelf = inventoryData.shelves.find(s => s.id === shelfId);
                    const modal = document.getElementById('shelfModal');
                    document.getElementById('shelfModalTitle').textContent = `Edit Shelf: ${shelf.name}`;
                    document.getElementById('shelfNameInput').value = shelf.name;
                    document.getElementById('shelfIdInput').value = shelf.id;
                    openModal(modal);
                }
                if (auditShelfBtn) {
                    startAudit(shelfId);
                }
            });

            viewUnassignedBtn.addEventListener('click', () => {
                showItemsModal('Unassigned Items', inventoryData.unassignedItems);
            });

            // --- Core Logic Functions ---
            const showItemsModal = (title, items, shelfId = null) => {
                const modal = document.getElementById('viewItemsModal');
                document.getElementById('viewItemsTitle').textContent = title;
                const contentEl = document.getElementById('viewItemsContent');
                contentEl.innerHTML = '';
                contentEl.dataset.shelfId = shelfId || '';
                
                saveLotSheetBtn.style.display = shelfId ? 'block' : 'none';

                selectedItems.clear();
                updateBulkActionsBar();

                if (items.length > 0) {
                    items.forEach(item => contentEl.appendChild(createItemElementForModal(item)));
                } else {
                    contentEl.innerHTML = '<p class="text-gray-500 italic text-center py-8">No items to show.</p>';
                }
                openModal(modal);
            };
            
            document.getElementById('viewItemsContent').addEventListener('click', async e => {
                const itemQrBtn = e.target.closest('.show-item-qr-btn');
                const deleteItemBtn = e.target.closest('.delete-item-btn');
                const editItemBtn = e.target.closest('.edit-item-btn');
                const checkbox = e.target.closest('.item-checkbox');
                
                if (checkbox) {
                    const itemName = checkbox.dataset.itemName;
                    if (checkbox.checked) {
                        selectedItems.add(itemName);
                    } else {
                        selectedItems.delete(itemName);
                    }
                    updateBulkActionsBar();
                }

                if (itemQrBtn) {
                    const itemName = itemQrBtn.closest('[data-name]').dataset.name;
                    const item = findItem(itemName);
                    showQrCode(`item_${encodeURIComponent(item.name)}`, `Item: ${item.name}`);
                }
                if (deleteItemBtn) {
                    const itemName = deleteItemBtn.closest('[data-name]').dataset.name;
                    const confirmed = await customConfirm(`Are you sure you want to permanently delete "${itemName}"?`);
                     if(confirmed) {
                         deleteItem(itemName);
                         showToast(`Item "${itemName}" deleted.`, 'info');
                         const currentShelfId = e.currentTarget.dataset.shelfId;
                         if (currentShelfId) {
                             const shelf = inventoryData.shelves.find(s => s.id === currentShelfId);
                             showItemsModal(`Items on: ${shelf.name}`, shelf.items, currentShelfId);
                         } else {
                             showItemsModal('Unassigned Items', inventoryData.unassignedItems);
                         }
                     }
                }
                if (editItemBtn) {
                    const itemName = editItemBtn.closest('[data-name]').dataset.name;
                    const item = findItem(itemName);
                    const modal = document.getElementById('itemModal');
                    document.getElementById('itemModalTitle').textContent = `Edit Item`;
                    document.getElementById('originalItemNameInput').value = item.name;
                    document.getElementById('itemNameInput').value = item.name;
                    document.getElementById('itemDescriptionInput').value = item.description || '';
                    document.getElementById('itemValueInput').value = item.value || '';
                    document.getElementById('itemAcquiredInput').value = item.acquired || '';
                    document.getElementById('itemConditionInput').value = item.condition || 'Unknown';
                    currentItemTags = new Set(item.tags || []);
                    renderCurrentItemTags();
                    openModal(modal);
                }
            });
            
            const deleteShelf = (shelfId) => {
                const shelfIndex = inventoryData.shelves.findIndex(s => s.id === shelfId);
                if (shelfIndex > -1) {
                    const shelf = inventoryData.shelves[shelfIndex];
                    inventoryData.unassignedItems.push(...shelf.items);
                    inventoryData.shelves.splice(shelfIndex, 1);
                    saveData();
                    renderShelvesListModal();
                }
            };

            const deleteItem = (itemName) => {
                inventoryData.shelves.forEach(shelf => {
                    shelf.items = shelf.items.filter(i => i.name !== itemName);
                });
                inventoryData.unassignedItems = inventoryData.unassignedItems.filter(i => i.name !== itemName);
                saveData();
            };
            
            const showQrCode = (data, title) => {
                const qrCodeTitle = document.getElementById('qrCodeTitle');
                const qrCodeCanvas = document.getElementById('qrCodeCanvas');
                qrCodeTitle.textContent = title;
                // Store data on the canvas element for the print function to access
                qrCodeCanvas.dataset.qrData = data;
                qrCodeCanvas.dataset.qrTitle = title;
                QRCode.toCanvas(qrCodeCanvas, data, { width: 256, margin: 2, errorCorrectionLevel: 'H' }, (error) => {
                    if (error) console.error(error);
                    openModal(document.getElementById('qrCodeModal'));
                });
            };
            
            // --- Single QR Code Printing ---
            document.getElementById('printQrCode').addEventListener('click', () => {
                const canvas = document.getElementById('qrCodeCanvas');
                const qrData = canvas.dataset.qrData;
                const title = canvas.dataset.qrTitle;

                if (!qrData) {
                    showToast('Could not retrieve QR data to print.', 'error');
                    return;
                }

                const printWindow = window.open('', 'PRINT', 'height=600,width=800');

                printWindow.document.write('<html><head><title>Print QR Code</title>');
                printWindow.document.write('<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"><\/script>');
                printWindow.document.write(`
                    <style>
                        body { display: flex; align-items: center; justify-content: center; height: 100%; margin: 0; font-family: sans-serif; }
                        .print-container { text-align: center; }
                        h1 { font-size: 24px; margin-bottom: 20px; }
                        canvas { max-width: 80%; }
                    </style>
                `);
                printWindow.document.write('</head><body>');
                printWindow.document.write(`<div class="print-container"><h1>${title}</h1><canvas id="print-canvas"></canvas></div>`);
                printWindow.document.write(`
                    <script>
                        document.addEventListener('DOMContentLoaded', () => {
                            const canvas = document.getElementById('print-canvas');
                            const qrData = ${JSON.stringify(qrData)}; // Safely embed the data
                            QRCode.toCanvas(canvas, qrData, { width: 300, margin: 2, errorCorrectionLevel: 'H' }, (error) => {
                                if (error) {
                                    console.error(error);
                                    document.body.innerHTML = 'Error generating QR code.';
                                    return;
                                }
                                // Use a short timeout to ensure rendering completes before printing
                                setTimeout(() => {
                                    window.focus();
                                    window.print();
                                    window.close();
                                }, 250);
                            });
                        });
                    <\/script>
                `);
                printWindow.document.write('</body></html>');
                printWindow.document.close();
            });

            // --- Shelf Modal Search & Sort ---
            document.getElementById('shelfSearchInput').addEventListener('input', renderShelvesListModal);
            document.getElementById('shelfSortSelect').addEventListener('change', renderShelvesListModal);
            
            // --- Import / Export ---
            const escapeCsvCell = (cell) => {
                if (cell === null || cell === undefined) return '';
                const cellStr = String(cell);
                if (cellStr.includes('"') || cellStr.includes(',') || cellStr.includes('\n')) {
                    return `"${cellStr.replace(/"/g, '""')}"`;
                }
                return cellStr;
            };

            exportBtn.addEventListener('click', () => {
                const allItems = [
                    ...inventoryData.unassignedItems.map(item => ({...item, shelfName: 'Unassigned'})),
                    ...inventoryData.shelves.flatMap(shelf => shelf.items.map(item => ({...item, shelfName: shelf.name})))
                ];

                if (allItems.length === 0) {
                    showToast('No items to export.', 'info');
                    return;
                }

                const headers = ['Name', 'Description', 'Value', 'AcquisitionDate', 'Condition', 'CurrentShelf', 'Tags'];
                const csvRows = [headers.join(',')];

                allItems.forEach(item => {
                    const row = [
                        item.name,
                        item.description,
                        item.value,
                        item.acquired,
                        item.condition,
                        item.shelfName,
                        (item.tags || []).join(';') // Join tags with a semicolon
                    ].map(escapeCsvCell);
                    csvRows.push(row.join(','));
                });

                const csvString = csvRows.join('\n');
                const dataBlob = new Blob([csvString], {type: "text/csv;charset=utf-8;"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `antique-arena-items-backup-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            });
            
            const parseCsvLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuotes && line[i+1] === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current);
                return result;
            };

            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split(/[\r\n]+/).filter(line => line.trim() !== '');
                        if (lines.length < 2) {
                            showToast('File is empty or contains only headers.', 'error');
                            return;
                        }
                        
                        const headers = parseCsvLine(lines[0]).map(h => h.trim());
                        const nameIndex = headers.indexOf('Name');
                        const descIndex = headers.indexOf('Description');
                        const valueIndex = headers.indexOf('Value');
                        const acquiredIndex = headers.indexOf('AcquisitionDate');
                        const conditionIndex = headers.indexOf('Condition');
                        const tagsIndex = headers.indexOf('Tags');

                        if (nameIndex === -1) {
                           showToast('Invalid CSV format. A "Name" column is required.', 'error');
                           return;
                        }

                        const newItems = [];
                        const existingNames = new Set([...inventoryData.unassignedItems.map(i => i.name), ...inventoryData.shelves.flatMap(s => s.items.map(i => i.name))]);

                        for (let i = 1; i < lines.length; i++) {
                            const data = parseCsvLine(lines[i]);
                            const itemName = data[nameIndex] || `Unnamed Item ${Date.now()}`;
                            
                            if (existingNames.has(itemName)) {
                                console.warn(`Skipping duplicate item from CSV: ${itemName}`);
                                continue;
                            }

                            const newItem = {
                                name: itemName,
                                description: data[descIndex] || '',
                                value: data[valueIndex] || '',
                                acquired: data[acquiredIndex] || '',
                                condition: data[conditionIndex] || 'Unknown',
                                tags: tagsIndex > -1 && data[tagsIndex] ? data[tagsIndex].split(';').map(t => t.trim()).filter(t => t) : []
                            };
                            newItems.push(newItem);
                            existingNames.add(itemName);
                        }

                        if (newItems.length > 0) {
                            inventoryData.unassignedItems.push(...newItems);
                            saveData();
                            showToast(`${newItems.length} new items imported successfully.`);
                        } else {
                            showToast('No new items to import.', 'info');
                        }

                    } catch (error) {
                        showToast('Error reading or parsing the file.', 'error');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset file input
            });
            
            // --- Bulk Actions ---
            const updateBulkActionsBar = () => {
                const bar = document.getElementById('bulkActionsBar');
                const countSpan = document.getElementById('selectedItemCount');
                if (selectedItems.size > 0) {
                    bar.classList.remove('hidden');
                    countSpan.textContent = selectedItems.size;
                } else {
                    bar.classList.add('hidden');
                }
            };
            
            const updateShelfBulkActionsBar = () => {
                const btn = document.getElementById('printSelectedShelvesBtn');
                btn.disabled = selectedShelves.size === 0;
            };

            document.getElementById('deleteSelectedBtn').addEventListener('click', async () => {
                const confirmed = await customConfirm(`Are you sure you want to delete ${selectedItems.size} selected items?`);
                if (confirmed) {
                    selectedItems.forEach(itemName => deleteItem(itemName));
                    showToast(`${selectedItems.size} items deleted.`, 'info');
                    closeModal(document.getElementById('viewItemsModal'));
                }
            });

            document.getElementById('moveSelectedBtn').addEventListener('click', () => {
                const currentShelfId = document.getElementById('viewItemsContent').dataset.shelfId;
                const shelfSelect = document.getElementById('moveShelfSelect');
                const searchInput = document.getElementById('moveShelfSearchInput');
                searchInput.value = ''; // Clear search
                
                const populateMoveOptions = (searchTerm = '') => {
                    shelfSelect.innerHTML = '';
                    const lowerCaseSearchTerm = searchTerm.toLowerCase();

                    // Add Unassigned as an option if it matches search
                    if ('unassigned items'.includes(lowerCaseSearchTerm)) {
                        const unassignedOption = document.createElement('option');
                        unassignedOption.value = 'unassigned';
                        unassignedOption.textContent = 'Unassigned Items';
                        shelfSelect.appendChild(unassignedOption);
                    }

                    // Add other shelves that match search
                    inventoryData.shelves
                        .filter(shelf => shelf.id !== currentShelfId && shelf.name.toLowerCase().includes(lowerCaseSearchTerm))
                        .sort((a, b) => a.name.localeCompare(b.name))
                        .forEach(shelf => {
                            const option = document.createElement('option');
                            option.value = shelf.id;
                            option.textContent = shelf.name;
                            shelfSelect.appendChild(option);
                        });
                };
                
                populateMoveOptions(); // Initial population
                searchInput.addEventListener('input', (e) => populateMoveOptions(e.target.value));

                if (shelfSelect.options.length === 0 && searchInput.value === '') {
                    showToast('No other shelves available to move items to.', 'info');
                    return;
                }

                openModal(document.getElementById('moveItemsModal'));
            });

            document.getElementById('confirmMoveBtn').addEventListener('click', () => {
                const destinationShelfId = document.getElementById('moveShelfSelect').value;
                if (!destinationShelfId) {
                    showToast('Please select a destination.', 'error');
                    return;
                }
                
                selectedItems.forEach(itemName => {
                    const item = findItem(itemName);
                    if (item) {
                        // Remove from old location
                        const oldLocation = findItemLocation(itemName);
                        if(oldLocation) oldLocation.list.splice(oldLocation.index, 1);

                        // Add to new location
                        if (destinationShelfId === 'unassigned') {
                            inventoryData.unassignedItems.push(item);
                        } else {
                            const destShelf = inventoryData.shelves.find(s => s.id === destinationShelfId);
                            if (destShelf) destShelf.items.push(item);
                        }
                    }
                });

                saveData();
                showToast(`${selectedItems.size} items moved successfully.`);
                closeModal(document.getElementById('moveItemsModal'));
                closeModal(document.getElementById('viewItemsModal'));
                renderShelvesListModal(); // Update shelf counts
            });
            
            // --- Lot Sheet Saving ---
            saveLotSheetBtn.addEventListener('click', () => {
                const shelfId = document.getElementById('viewItemsContent').dataset.shelfId;
                const shelf = inventoryData.shelves.find(s => s.id === shelfId);
                if (!shelf || shelf.items.length === 0) {
                    showToast('No items on this shelf to save.', 'info');
                    return;
                }

                const headers = ['ItemName'];
                const csvRows = [headers.join(',')];

                shelf.items.forEach(item => {
                    csvRows.push(escapeCsvCell(item.name));
                });

                const csvString = csvRows.join('\n');
                const dataBlob = new Blob([csvString], {type: "text/csv;charset=utf-8;"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const safeShelfName = shelf.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                link.download = `lot-sheet-${safeShelfName}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast(`Lot sheet for "${shelf.name}" saved.`);
            });


            // --- Scanning & Audit Mode ---
            const startScanner = async (videoElement) => {
                try {
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    videoElement.srcObject = videoStream;
                    videoElement.setAttribute("playsinline", true);
                    videoElement.play();
                    videoElement.parentElement.classList.remove('hidden');
                    if (currentScanMode === 'add/remove') {
                        resetScanState();
                    }
                    requestAnimationFrame(tick);
                } catch (err) {
                    showToast('Could not access camera.', 'error');
                    console.error("Error accessing camera", err);
                    const statusEl = currentScanMode === 'audit' ? document.getElementById('audit-scan-status') : document.getElementById('scan-status');
                    if (statusEl) statusEl.textContent = "Could not access camera. Please grant permission.";
                }
            };

            const stopScanner = () => {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                }
                currentScanMode = null;
                currentAuditShelf = null;
            };
            
            const resetScanState = () => {
                currentShelfId = null;
                document.getElementById('scan-status').textContent = 'Please scan a SHELF QR code.';
                document.getElementById('current-shelf-info').textContent = 'No shelf selected.';
                const scanAddBtn = document.getElementById('scan-add-btn');
                const scanRemoveBtn = document.getElementById('scan-remove-btn');
                scanAddBtn.disabled = true;
                scanRemoveBtn.disabled = true;
                scanAddBtn.classList.remove('bg-green-800', 'ring-4', 'ring-green-300');
                scanRemoveBtn.classList.remove('bg-red-800', 'ring-4', 'ring-red-300');
            };
            
            document.getElementById('scan-add-btn').addEventListener('click', () => {
                currentScanMode = 'add';
                document.getElementById('scan-status').textContent = 'MODE: ADD. Scan an ITEM to add to the shelf.';
                document.getElementById('scan-add-btn').classList.add('bg-green-800', 'ring-4', 'ring-green-300');
                document.getElementById('scan-remove-btn').classList.remove('bg-red-800', 'ring-4', 'ring-red-300');
            });

            document.getElementById('scan-remove-btn').addEventListener('click', () => {
                currentScanMode = 'remove';
                document.getElementById('scan-status').textContent = 'MODE: REMOVE. Scan an ITEM to remove from the shelf.';
                document.getElementById('scan-remove-btn').classList.add('bg-red-800', 'ring-4', 'ring-red-300');
                document.getElementById('scan-add-btn').classList.remove('bg-green-800', 'ring-4', 'ring-green-300');
            });

            function tick() {
                if (!videoStream) return;

                let video;
                if (currentScanMode === 'audit') {
                    video = document.getElementById('audit-qr-video');
                } else if (currentScanMode) { // Covers 'add', 'remove', 'add/remove'
                    video = document.getElementById('qr-video');
                } else {
                    return;
                }

                if (video && video.readyState === video.HAVE_ENOUGH_DATA) {
                    const canvasElement = document.createElement('canvas');
                    const canvas = canvasElement.getContext('2d');
                    canvasElement.height = video.videoHeight;
                    canvasElement.width = video.videoWidth;
                    canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                    const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                    
                    if (code) {
                        if (currentScanMode === 'audit') {
                            handleAuditScan(code.data);
                        } else {
                            handleQrCodeScan(code.data);
                        }
                    }
                }
                requestAnimationFrame(tick);
            }
            
            let lastScanTime = 0;
            function handleQrCodeScan(data) {
                const now = Date.now();
                if (now - lastScanTime < 3000) return;
                lastScanTime = now;
                const scanStatus = document.getElementById('scan-status');

                if (data.startsWith('shelf_')) {
                    const shelf = inventoryData.shelves.find(s => s.id === data);
                    if (shelf) {
                        currentShelfId = shelf.id;
                        document.getElementById('current-shelf-info').textContent = `Selected Shelf: ${shelf.name}`;
                        scanStatus.textContent = 'Shelf selected. Choose ADD or REMOVE mode.';
                        document.getElementById('scan-add-btn').disabled = false;
                        document.getElementById('scan-remove-btn').disabled = false;
                    } else {
                        scanStatus.textContent = 'Scanned an unknown shelf QR. Please try again.';
                    }
                } else if (data.startsWith('item_')) {
                    const itemName = decodeURIComponent(data.substring(5));
                    if (!currentShelfId) {
                        scanStatus.textContent = 'Please scan a SHELF first before scanning items.';
                        return;
                    }
                    if (!currentScanMode || currentScanMode === 'add/remove') {
                        scanStatus.textContent = 'Please select ADD or REMOVE mode first.';
                        return;
                    }
                    const item = findItem(itemName);
                    if (!item) {
                        scanStatus.textContent = `Unknown item QR scanned: ${itemName}`;
                        return;
                    }
                    if (currentScanMode === 'add') addItemToShelf(item.name, currentShelfId);
                    else if (currentScanMode === 'remove') removeItemFromShelf(item.name, currentShelfId);
                } else {
                    scanStatus.textContent = 'Invalid QR code scanned.';
                }
            }

            const addItemToShelf = (itemName, shelfId) => {
                const shelf = inventoryData.shelves.find(s => s.id === shelfId);
                const item = findItem(itemName);
                const scanStatus = document.getElementById('scan-status');
                if (!shelf || !item) return;
                if (shelf.items.some(i => i.name === itemName)) {
                    scanStatus.textContent = `Item '${item.name}' is already on this shelf.`;
                    return;
                }
                inventoryData.shelves.forEach(s => { s.items = s.items.filter(i => i.name !== itemName); });
                inventoryData.unassignedItems = inventoryData.unassignedItems.filter(i => i.name !== itemName);
                shelf.items.push(item);
                saveData();
                scanStatus.textContent = `SUCCESS: Added '${item.name}' to '${shelf.name}'. Scan next item.`;
                showToast(`Added '${item.name}' to '${shelf.name}'.`);
            };

            const removeItemFromShelf = (itemName, shelfId) => {
                const shelf = inventoryData.shelves.find(s => s.id === shelfId);
                const item = findItem(itemName);
                const scanStatus = document.getElementById('scan-status');
                if (!shelf || !item) return;
                const itemIndex = shelf.items.findIndex(i => i.name === itemName);
                if (itemIndex > -1) {
                    shelf.items.splice(itemIndex, 1);
                    inventoryData.unassignedItems.push(item);
                    saveData();
                    scanStatus.textContent = `SUCCESS: Removed '${item.name}' from '${shelf.name}'. Scan next item.`;
                    showToast(`Removed '${item.name}' from '${shelf.name}'.`, 'info');
                } else {
                     scanStatus.textContent = `Item '${item.name}' is not on this shelf.`;
                }
            };
            
            // --- Audit Mode ---
            const startAudit = (shelfId) => {
                currentAuditShelf = inventoryData.shelves.find(s => s.id === shelfId);
                if (!currentAuditShelf) return;

                const modal = document.getElementById('auditModal');
                document.getElementById('auditModalTitle').textContent = `Auditing Shelf: ${currentAuditShelf.name}`;

                const missingList = document.getElementById('audit-missing-list');
                const foundList = document.getElementById('audit-found-list');
                const unexpectedList = document.getElementById('audit-unexpected-list');
                
                missingList.innerHTML = '';
                foundList.innerHTML = '';
                unexpectedList.innerHTML = '';

                currentAuditShelf.items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-2 bg-red-100 text-red-800 rounded';
                    itemEl.textContent = item.name;
                    itemEl.dataset.itemName = item.name;
                    missingList.appendChild(itemEl);
                });
                
                updateAuditCounts();
                openModal(modal);
                currentScanMode = 'audit';
                startScanner(document.getElementById('audit-qr-video'));
            };

            const updateAuditCounts = () => {
                document.getElementById('audit-found-count').textContent = document.getElementById('audit-found-list').children.length;
                document.getElementById('audit-missing-count').textContent = document.getElementById('audit-missing-list').children.length;
                document.getElementById('audit-unexpected-count').textContent = document.getElementById('audit-unexpected-list').children.length;
            };

            const handleAuditScan = (data) => {
                const now = Date.now();
                if (now - lastScanTime < 2000) return; // 2 second cooldown for audit scans
                lastScanTime = now;

                if (!data.startsWith('item_')) {
                    showToast('Scanned QR is not an item.', 'error');
                    return;
                }
                const itemName = decodeURIComponent(data.substring(5));
                
                const missingList = document.getElementById('audit-missing-list');
                const foundList = document.getElementById('audit-found-list');
                const unexpectedList = document.getElementById('audit-unexpected-list');
                
                // Check if item was expected and is in the missing list
                const missingItemEl = missingList.querySelector(`[data-item-name="${itemName}"]`);
                if (missingItemEl) {
                    missingItemEl.className = 'p-2 bg-green-100 text-green-800 rounded';
                    foundList.appendChild(missingItemEl);
                    showToast(`Found: ${itemName}`, 'success');
                    updateAuditCounts();
                    return;
                }

                // Check if item was already found
                if (foundList.querySelector(`[data-item-name="${itemName}"]`)) {
                    showToast(`Already found: ${itemName}`, 'info');
                    return;
                }
                
                // Check if item is unexpected
                if (unexpectedList.querySelector(`[data-item-name="${itemName}"]`)) {
                    showToast(`Already found (unexpected): ${itemName}`, 'info');
                    return;
                }

                const itemLocation = findItemLocation(itemName);
                if (itemLocation) {
                    const unexpectedItemEl = document.createElement('div');
                    unexpectedItemEl.className = 'p-2 bg-yellow-100 text-yellow-800 rounded';
                    const locationText = itemLocation.shelf ? `(Belongs on: ${itemLocation.shelf.name})` : '(Belongs in: Unassigned)';
                    unexpectedItemEl.textContent = `${itemName} ${locationText}`;
                    unexpectedItemEl.dataset.itemName = itemName;
                    unexpectedList.appendChild(unexpectedItemEl);
                    showToast(`Unexpected item: ${itemName}`, 'info');
                    updateAuditCounts();
                } else {
                    showToast(`Scanned an unknown item: ${itemName}`, 'error');
                }
            };

            finishAuditBtn.addEventListener('click', () => {
                stopScanner();
                closeModal(document.getElementById('auditModal'));
                currentAuditShelf = null;
            });

            // --- Tagging ---
            const itemTagsInput = document.getElementById('itemTagsInput');
            const itemTagsContainer = document.getElementById('itemTagsContainer');

            const renderCurrentItemTags = () => {
                itemTagsContainer.innerHTML = '';
                currentItemTags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'tag';
                    tagEl.innerHTML = `${tag} <span class="tag-remove" data-tag="${tag}">&times;</span>`;
                    itemTagsContainer.appendChild(tagEl);
                });
            };

            const updateTagsDatalist = () => {
                const datalist = document.getElementById('tagsDatalist');
                datalist.innerHTML = '';
                inventoryData.allTags.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag;
                    datalist.appendChild(option);
                });
            };

            itemTagsInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const tag = itemTagsInput.value.trim();
                    if (tag) {
                        currentItemTags.add(tag);
                        renderCurrentItemTags();
                        itemTagsInput.value = '';
                    }
                }
            });

            itemTagsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('tag-remove')) {
                    const tagToRemove = e.target.dataset.tag;
                    currentItemTags.delete(tagToRemove);
                    renderCurrentItemTags();
                }
            });
            
            // --- QR Code Sheet Generation ---
            const generateQrSheet = (itemsToPrint, type) => {
                if (itemsToPrint.length === 0) {
                    showToast(`Please select ${type}s to generate a QR sheet.`, 'info');
                    return;
                }

                const printWindow = window.open('', 'PRINT', 'height=800,width=1000');
                printWindow.document.write(`<html><head><title>${type.charAt(0).toUpperCase() + type.slice(1)} QR Code Sheet</title>`);
                printWindow.document.write(`
                    <style>
                        body { font-family: sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
                        .label {
                            display: flex; flex-direction: column; align-items: center; justify-content: center;
                            border: 1px dashed #999; padding: 15px; page-break-inside: avoid;
                            text-align: center; height: 220px; box-sizing: border-box;
                        }
                        .label canvas { max-width: 150px; max-height: 150px; flex-grow: 1; }
                        .label-name { margin-top: 10px; font-size: 14px; font-weight: bold; word-wrap: break-word; }
                        .print-button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #4CAF50; color: white; border: none; border-radius: 5px; }
                        @media print {
                            .no-print { display: none; }
                            body { margin: 10px; }
                            .label { border: 1px solid #000; }
                        }
                    </style>
                `);
                printWindow.document.write('</head><body>');
                printWindow.document.write('<div class="header no-print"><h1>QR Code Sheet</h1><p>Ready to print. Use your browser\'s print settings to adjust layout (e.g., "Scale" or "Pages per sheet").</p><button class="print-button" onclick="window.print()">Print Now</button><hr></div>');
                printWindow.document.write('<div class="grid-container" id="grid"></div>');
                printWindow.document.write('</body></html>');
                
                const grid = printWindow.document.getElementById('grid');
                const promises = [];

                itemsToPrint.forEach(item => {
                    const labelDiv = printWindow.document.createElement('div');
                    labelDiv.className = 'label';

                    const canvas = printWindow.document.createElement('canvas');
                    const nameDiv = printWindow.document.createElement('div');
                    nameDiv.className = 'label-name';
                    nameDiv.textContent = item.name;

                    labelDiv.appendChild(canvas);
                    labelDiv.appendChild(nameDiv);
                    grid.appendChild(labelDiv);

                    const qrPromise = new Promise((resolve, reject) => {
                        const qrData = type === 'item' ? `item_${encodeURIComponent(item.name)}` : item.id;
                        QRCode.toCanvas(canvas, qrData, { width: 180, margin: 2, errorCorrectionLevel: 'H' }, (error) => {
                            if (error) {
                                console.error(`QR Code generation failed for ${item.name}:`, error);
                                reject(error);
                            } else {
                                resolve();
                            }
                        });
                    });
                    promises.push(qrPromise);
                });

                Promise.all(promises)
                    .then(() => {
                        printWindow.focus();
                        // A short timeout can help ensure all images are rendered before the print dialog appears
                        setTimeout(() => {
                           printWindow.print();
                        }, 500);
                    })
                    .catch(error => {
                        console.error('Failed to render one or more QR codes.', error);
                        printWindow.alert('Could not generate all QR codes. Please check the console for errors.');
                    });
                
                printWindow.document.close();
            }

            generateQrSheetBtn.addEventListener('click', () => {
                const itemsToPrint = Array.from(selectedItems).map(name => findItem(name)).filter(Boolean);
                generateQrSheet(itemsToPrint, 'item');
            });

            document.getElementById('printSelectedShelvesBtn').addEventListener('click', () => {
                const shelvesToPrint = Array.from(selectedShelves).map(id => inventoryData.shelves.find(s => s.id === id)).filter(Boolean);
                generateQrSheet(shelvesToPrint, 'shelf');
            });


            // Initial Render
            updateDashboard();
            updateTagsDatalist();
        });
    </script>
</body>
</html>
